name: Create Issues from CSV

on:
  workflow_dispatch:
    inputs:
      csv_file:
        description: 'Path to CSV file (relative to repository root)'
        required: true
        default: '.github/issues.csv'

jobs:
  create-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create issues from CSV
        env:
          GH_TOKEN: ${{ github.token }}
          CSV_FILE: ${{ github.event.inputs.csv_file }}
        run: |
          if [ ! -f "$CSV_FILE" ]; then
            echo "CSV file not found: $CSV_FILE"
            exit 1
          fi

          echo "Processing CSV file: $CSV_FILE"

          # Use Python to properly parse CSV with quoted fields
          python3 << 'EOF'
          import csv
          import subprocess
          import time
          import sys
          import os

          csv_file = os.environ['CSV_FILE']

          with open(csv_file, 'r', encoding='utf-8') as f:
              reader = csv.DictReader(f)
              for row in reader:
                  title = row['title'].strip()
                  body = row['body'].strip()
                  labels = row['labels'].strip()
                  assignees = row['assignees'].strip()

                  if not title:
                      continue

                  print(f"Creating issue: {title}")

                  # Build gh issue create command
                  cmd = ['gh', 'issue', 'create', '--title', title, '--body', body]

                  # Add labels if provided
                  if labels:
                      for label in labels.split(','):
                          label = label.strip()
                          if label:
                              cmd.extend(['--label', label])

                  # Add assignees if provided (skip if empty)
                  if assignees:
                      for assignee in assignees.split(','):
                          assignee = assignee.strip()
                          if assignee:
                              cmd.extend(['--assignee', assignee])

                  # Execute command
                  try:
                      result = subprocess.run(cmd, check=True, capture_output=True, text=True)
                      print(f"✓ Created: {result.stdout.strip()}")
                  except subprocess.CalledProcessError as e:
                      print(f"✗ Error creating issue '{title}': {e.stderr}", file=sys.stderr)
                      sys.exit(1)

                  # Small delay to avoid rate limiting
                  time.sleep(1)

          print("\nAll issues created successfully!")
          EOF

      - name: Summary
        run: |
          echo "### Issues Created from CSV" >> $GITHUB_STEP_SUMMARY
          echo "CSV file processed: ${{ github.event.inputs.csv_file }}" >> $GITHUB_STEP_SUMMARY
          echo "Issues have been created in the repository." >> $GITHUB_STEP_SUMMARY
