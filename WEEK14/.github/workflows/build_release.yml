name: Release Build Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-2022

    strategy:
      matrix:
        configuration: [ Release ] # Configuration만 다릅니다.
        platform: [ x64 ]
      fail-fast: false

    steps:
      # 1. 코드 체크아웃 (LFS는 캐시 이후에 pull, submodule도 포함)
      - name: Checkout Code (no LFS)
        uses: actions/checkout@v4
        with:
          lfs: false # LFS 파일은 캐시 복원 후에 별도로 받습니다.
          submodules: true # BuildTools submodule 체크아웃

      # 2. LFS 캐시 키 생성 - 커밋 해시 기반 (git lfs ls-files 호출 없음)
      #    .gitattributes 파일의 해시와 현재 커밋 해시를 조합하여 캐시 키 생성
      - name: Generate LFS cache key
        run: |
          GITATTRIBUTES_HASH=$(git hash-object .gitattributes 2>/dev/null || echo "no-gitattributes")
          echo "LFS_CACHE_KEY=${{ github.sha }}-${GITATTRIBUTES_HASH}" >> $GITHUB_ENV
        shell: bash

      # 3. LFS 객체 캐시 복원
      - name: Restore LFS cache
        uses: actions/cache@v4
        id: lfs-cache
        with:
          path: .git/lfs/objects
          key: lfs-${{ runner.os }}-${{ env.LFS_CACHE_KEY }}
          restore-keys: |
            lfs-${{ runner.os }}-${{ github.sha }}-
            lfs-${{ runner.os }}-${{ github.ref_name }}-
            lfs-${{ runner.os }}-

      # 4. LFS 파일 pull (캐시된 파일은 건너뜀)
      - name: Pull LFS files
        run: git lfs pull

      # --- 여기부터는 기존 워크플로우와 동일합니다 ---

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Set UTF-8 Code Page
        run: |
          chcp 65001
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          [Console]::InputEncoding = [System.Text.Encoding]::UTF8

      - name: Build Solution
        run: |
          chcp 65001
          msbuild Mundi.sln /p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }} /p:PlatformToolset=v143 /verbosity:minimal

      - name: Upload Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: game-jam-build-${{ matrix.configuration }}-${{ matrix.platform }}
          path: |
            x64/${{ matrix.configuration }}/Engine.exe
            x64/${{ matrix.configuration }}/Engine.pdb
          retention-days: 7

      - name: Upload Build Logs (On Failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.configuration }}-${{ matrix.platform }}
          path: |
            UnlearnEngine/x64/${{ matrix.configuration }}/*.log
            *.log
          retention-days: 7
